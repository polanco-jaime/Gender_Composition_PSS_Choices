CREATE OR REPLACE TABLE `ph-jabri.ICFES.SB11_SBPRO`
OPTIONS () AS 
WITH 
SBPRO_KEYS AS  
 (
SELECT * EXCEPT(ANIO, id_master, id_using), 
      ANIO AS YEAR_SBPRO, 
      ESTU_CONSECUTIVO AS ESTU_CONSECUTIVO_SBPRO,
      id_master AS id_master_PRO,
      id_using AS id_using_PRO
FROM `ph-jabri.SABER_PRO.UNCLEAN_SBPRO_2006_2022`  
LEFT  JOIN   `ph-jabri.ICFES.Saber11_SaberPro`
ON rtrim(ltrim(replace(ESTU_CONSECUTIVO, 'SB11','SABER11'))) =  rtrim(ltrim(replace(id_using, 'SB11','SABER11')))
WHERE cast(ANIO as numeric) >= 2015
 
), 
SB11_KEYS AS (
SELECT * EXCEPT(ANIO, ESTU_CONSECUTIVO, ESTU_GENERO, ESTU_FECHANACIMIENTO , PERIODO, ESTU_INSE_INDIVIDUAL ), 
      ANIO AS YEAR_SB11, 
      ESTU_CONSECUTIVO AS ESTU_CONSECUTIVO_SB11 ,
      ESTU_GENERO AS ESTU_GENERO_SB11, 
      ESTU_FECHANACIMIENTO  AS ESTU_FECHANACIMIENTO_SB11, 
      PERIODO AS PERIODO_SB11, 
      ESTU_INSE_INDIVIDUAL AS ESTU_INSE_INDIVIDUAL_SB11
FROM `ph-jabri.ICFES.SABER_11_2006_2021`  
LEFT  JOIN   `ph-jabri.ICFES.Saber11_SaberPro`
ON rtrim(ltrim(replace(ESTU_CONSECUTIVO, 'SB11','SABER11'))) =  rtrim(ltrim(replace(id_master, 'SB11','SABER11')))
WHERE cast(ANIO as numeric) BETWEEN  2010 AND  2014
)
SELECT * FROM SB11_KEYS 
LEFT JOIN SBPRO_KEYS
ON    id_master = id_master_PRO
      AND id_using = id_using_PRO
